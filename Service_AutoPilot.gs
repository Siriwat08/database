/**
 * ü§ñ Service: Auto Pilot 
 */

/**
 * ‚ñ∂Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö Auto-Pilot
 * ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ 10 ‡∏ô‡∏≤‡∏ó‡∏µ
 */
function START_AUTO_PILOT() {
  // 1. ‡∏•‡∏ö Trigger ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
  STOP_AUTO_PILOT();
  
  // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡πÉ‡∏´‡∏°‡πà
  ScriptApp.newTrigger("autoPilotRoutine")
    .timeBased()
    .everyMinutes(10)
    .create();
    
  // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  var ui = SpreadsheetApp.getUi();
  ui.alert("‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö Auto-Pilot ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡πÜ 10 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö");
}

/**
 * ‚èπÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö Auto-Pilot
 * ‡∏•‡∏ö Trigger ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
 */
function STOP_AUTO_PILOT() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === "autoPilotRoutine") {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å START ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå Alert ‡∏ô‡∏µ‡πâ)
  try {
     var caller = arguments.callee.caller;
     if (!caller || caller.name !== "START_AUTO_PILOT") {
        SpreadsheetApp.getUi().alert("‚èπÔ∏è ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö Auto-Pilot ‡πÅ‡∏•‡πâ‡∏ß");
     }
  } catch(e) {}
}

/**
 * ‚öôÔ∏è Routine Function (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
 * ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Trigger ‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ
 */
function autoPilotRoutine() {
  // ---------------------------------------------------------
  // ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏° UUID ‡πÉ‡∏ô Database ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
  // ---------------------------------------------------------
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var dbSheet = ss.getSheetByName(CONFIG.SHEET_NAME);
    
    if (dbSheet) {
      var lastRow = dbSheet.getLastRow();
      if (lastRow > 1) {
         // ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå UUID (K)
         var range = dbSheet.getRange(2, CONFIG.COL_UUID, lastRow - 1, 1);
         var values = range.getValues();
         var changed = false;
         
         for(var i = 0; i < values.length; i++) {
           // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á UUID ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
           if(!values[i][0] || values[i][0] === "") { 
             values[i][0] = Utilities.getUuid(); 
             changed = true; 
           }
         }
         
         // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
         if(changed) {
           range.setValues(values);
           console.log("AutoPilot: Generated missing UUIDs.");
         }
      }
    }
  } catch (e) {
    console.error("AutoPilot Error (UUID): " + e.message);
  }
  
  // ---------------------------------------------------------
  // ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î/‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (SCG Data)
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≤‡∏Å Service_SCG.gs
  // ---------------------------------------------------------
  try {
     // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏µ‡∏ï Data ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
     var ss = SpreadsheetApp.getActiveSpreadsheet();
     var dataSheet = ss.getSheetByName(SCG_CONFIG.SHEET_DATA);
     if (dataSheet && dataSheet.getLastRow() > 1) {
        applyMasterCoordinatesToDailyJob();
        console.log("AutoPilot: Updated SCG Coordinates.");
     }
  } catch(e) {
    console.error("AutoPilot Error (SCG): " + e.message);
  }
}

